<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Diagnostics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007cba;
        }
        .status-ok {
            border-left-color: #28a745;
        }
        .status-error {
            border-left-color: #dc3545;
        }
        .status-warning {
            border-left-color: #ffc107;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Netlify CMS Diagnostics</h1>
    
    <div class="diagnostic-item" id="config-check">
        <h3>üìÑ Config File Check</h3>
        <p>Checking if admin/config.yml exists and is accessible...</p>
    </div>
    
    <div class="diagnostic-item" id="products-check">
        <h3>üì¶ Products File Check</h3>
        <p>Checking if products.json exists and is accessible...</p>
    </div>
    
    <div class="diagnostic-item" id="netlify-identity-check">
        <h3>üîê Netlify Identity Check</h3>
        <p>Checking if Netlify Identity is loaded...</p>
    </div>
    
    <div class="diagnostic-item" id="cms-load-check">
        <h3>‚öôÔ∏è CMS Load Check</h3>
        <p>Testing if Netlify CMS can be loaded...</p>
    </div>
    
    <div class="diagnostic-item">
        <h3>üõ†Ô∏è Manual Tests</h3>
        <button onclick="testConfigLoad()">Test Config Load</button>
        <button onclick="testProductsLoad()">Test Products Load</button>
        <button onclick="testCMSInit()">Test CMS Init</button>
        <button onclick="window.location.href='/admin/'">Go to Admin</button>
    </div>
    
    <div id="results"></div>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `diagnostic-item status-${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            results.appendChild(div);
        }
        
        // Check config file
        fetch('/admin/config.yml')
            .then(response => {
                if (response.ok) {
                    document.getElementById('config-check').className += ' status-ok';
                    document.getElementById('config-check').innerHTML += '<p>‚úÖ Config file accessible</p>';
                } else {
                    document.getElementById('config-check').className += ' status-error';
                    document.getElementById('config-check').innerHTML += '<p>‚ùå Config file not accessible</p>';
                }
            })
            .catch(err => {
                document.getElementById('config-check').className += ' status-error';
                document.getElementById('config-check').innerHTML += '<p>‚ùå Error loading config: ' + err.message + '</p>';
            });
        
        // Check products file
        fetch('/products.json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('products-check').className += ' status-ok';
                document.getElementById('products-check').innerHTML += `<p>‚úÖ Products file accessible (${data.products.length} products)</p>`;
            })
            .catch(err => {
                document.getElementById('products-check').className += ' status-error';
                document.getElementById('products-check').innerHTML += '<p>‚ùå Error loading products: ' + err.message + '</p>';
            });
        
        // Check Netlify Identity
        if (window.netlifyIdentity) {
            document.getElementById('netlify-identity-check').className += ' status-ok';
            document.getElementById('netlify-identity-check').innerHTML += '<p>‚úÖ Netlify Identity loaded</p>';
            
            netlifyIdentity.on('init', user => {
                if (user) {
                    addResult(`User authenticated: ${user.email}`, 'ok');
                } else {
                    addResult('No user authenticated', 'warning');
                }
            });
        } else {
            document.getElementById('netlify-identity-check').className += ' status-error';
            document.getElementById('netlify-identity-check').innerHTML += '<p>‚ùå Netlify Identity not loaded</p>';
        }
        
        function testConfigLoad() {
            fetch('/admin/config.yml')
                .then(response => response.text())
                .then(text => {
                    addResult('Config YAML content:\n' + text.substring(0, 500) + '...', 'ok');
                })
                .catch(err => addResult('Config load error: ' + err.message, 'error'));
        }
        
        function testProductsLoad() {
            fetch('/products.json')
                .then(response => response.json())
                .then(data => {
                    addResult('Products data:\n' + JSON.stringify(data, null, 2).substring(0, 500) + '...', 'ok');
                })
                .catch(err => addResult('Products load error: ' + err.message, 'error'));
        }
        
        function testCMSInit() {
            try {
                // Try to load CMS script dynamically
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js';
                script.onload = () => {
                    addResult('‚úÖ CMS script loaded successfully', 'ok');
                    if (window.CMS) {
                        addResult('‚úÖ CMS object available', 'ok');
                    } else {
                        addResult('‚ö†Ô∏è CMS script loaded but CMS object not available', 'warning');
                    }
                };
                script.onerror = (err) => {
                    addResult('‚ùå Failed to load CMS script: ' + err.message, 'error');
                };
                document.head.appendChild(script);
            } catch (err) {
                addResult('CMS init error: ' + err.message, 'error');
            }
        }
        
        // Auto-run some checks
        setTimeout(() => {
            if (window.netlifyIdentity) {
                netlifyIdentity.init();
            }
        }, 1000);
    </script>
</body>
</html>