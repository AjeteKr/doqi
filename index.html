<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="High-quality furniture and mattress production by DoÃ§i Shpk in partnership with Starflex" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />
    <title>DoqiSHPK</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    
    <!-- Handle Netlify Identity redirects -->
    <script>
      // Prevent redirect loops by tracking redirect attempts
      const MAX_REDIRECTS = 3;
      const REDIRECT_KEY = 'netlify_redirect_count';
      
      function getRedirectCount() {
        const count = sessionStorage.getItem(REDIRECT_KEY);
        return count ? parseInt(count) : 0;
      }
      
      function incrementRedirectCount() {
        const count = getRedirectCount() + 1;
        sessionStorage.setItem(REDIRECT_KEY, count.toString());
        return count;
      }
      
      function clearRedirectCount() {
        sessionStorage.removeItem(REDIRECT_KEY);
      }
      
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on("init", user => {
          // Clear redirect count on successful page load
          setTimeout(() => clearRedirectCount(), 2000);
          
          // If user is already logged in and on homepage, show admin button
          if (user && window.location.pathname === '/') {
            console.log('User already logged in:', user);
            // Add admin button to page
            setTimeout(() => {
              const adminBtn = document.createElement('button');
              adminBtn.innerText = 'Go to Admin Panel';
              adminBtn.style.cssText = 'position:fixed; top:20px; right:20px; z-index:9999; padding:10px 20px; background:#007acc; color:white; border:none; border-radius:5px; cursor:pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
              adminBtn.onclick = () => {
                // Use relative path to avoid domain issues
                window.location.href = './admin/';
              };
              document.body.appendChild(adminBtn);
            }, 1000);
          }
        });
        
        // Handle login events with loop prevention
        window.netlifyIdentity.on("login", (user) => {
          console.log('Login successful for user:', user.email);
          
          const redirectCount = getRedirectCount();
          if (redirectCount >= MAX_REDIRECTS) {
            console.warn('Too many redirects, stopping automatic redirect');
            alert('Login successful! Please manually navigate to the admin panel.');
            return;
          }
          
          incrementRedirectCount();
          console.log('Redirecting to admin panel... (attempt ' + redirectCount + ')');
          
          // Use setTimeout to ensure the login process completes
          setTimeout(() => {
            window.location.href = "./admin/";
          }, 1000);
        });
        
        // Handle logout
        window.netlifyIdentity.on("logout", () => {
          clearRedirectCount();
          console.log('User logged out');
        });
      }
    </script>
  </body>
</html>